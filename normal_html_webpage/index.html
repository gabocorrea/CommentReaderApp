<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>CommentsReaderApp</title>

  <!-- Latest compiled and minified CSS -->
  <link rel="stylesheet" href="bootstrap/bootstrap.min.css">

  <!-- Optional theme -->
  <link rel="stylesheet" href="bootstrap/bootstrap-theme.min.css">

  <script type="text/javascript" src="scripts/jquery-2.1.3.js"></script>
  <script type="text/javascript" src="scripts/keypress.js"></script>
  <script type="text/javascript">
    $(document).ready(function() {
      var listener = new window.keypress.Listener();
      listener.simple_combo("y", yes);
      listener.simple_combo("n", no);
      listener.simple_combo("up", function() {previousPhrase(); updateMyLogger();});
      listener.simple_combo("down", function() {nextPhrase(); updateMyLogger();});
      listener.simple_combo("right", function() {nextComment(); updateMyLogger();});
      listener.simple_combo("left", function() {previousComment(1); updateMyLogger();});
      $('#file').on('fileselect', function(event, numFiles, label) {
        $('#file_name').val(label);
      });
    })
  </script>

  <style>
  .btn-file {
    position: relative;
    overflow: hidden;
  }
  .btn-file input[type=file] {
    position: absolute;
    top: 0;
    right: 0;
    min-width: 100%;
    min-height: 100%;
    font-size: 100px;
    text-align: right;
    filter: alpha(opacity=0);
    opacity: 0;
    background: red;
    cursor: inherit;
    display: block;
  }
  input[readonly] {
    background-color: white !important;
    cursor: text !important;
  }

  mark{color:#000;background:#ff0}
  </style>


</head>
<body>

  <div class="container" style="margin-top: 10px">

    <div class="row" style="margin-bottom: 10px">
      <div class="col-lg-6 col-sm-6 col-12">
        <h4>Open a file with comments:</h4>
        <div class="input-group">
          <span class="input-group-btn">
            <span class="btn btn-info btn-file">
              Browse <input type="file" id="file">
            </span>
          </span>
          <input id='file_name' type="text" class="form-control" readonly>
        </div>
      </div>
    </div>


    <div id="buttons_and_comments">
      <div id="buttons" style="margin-top: 30px">
        <div class="row">
          <div class="btn-group col-md-3 col-md-offset-5">
            <button type="button" class="btn btn-success btn-lg btn-block" onclick="yes();">
              <span class="glyphicon glyphicon-triangle-top" aria-hidden="true"></span>
              Directive
            </button>
          </div>
        </div>


        <div class="row">
          <div class="col-md-2 col-md-offset-3">
            <button type="button" class="btn btn-default btn-lg btn-block" onclick="previousComment();">
              <span class="glyphicon glyphicon-triangle-left" aria-hidden="true"></span>
              Prev
            </button>
          </div>
          <div class="col-md-3">
            <button type="button" class="btn btn-danger btn-lg btn-block" onclick="no();">
              <span class="glyphicon glyphicon-triangle-bottom" aria-hidden="true"></span>
              Non-Directive
            </button>
          </div>
          <div class="col-md-2">
            <button type="button" class="btn btn-default btn-lg btn-block" onclick="nextComment();">
              Next
              <span class="glyphicon glyphicon-triangle-right" aria-hidden="true"></span>
            </button>
          </div>
        </div>
      </div>


      <br>
      <br>
      <div class="text-center">
        <h3 id="id_comment">id</h3>
        <p id='mylogger'></p>
      </div>

      <div class="text-center">
        <h3 id="mylogger"></h3>
      </div>

      <!--<h3>Comment:</h3>-->

      <div id="comment">
        <code><pre id="commentPre">
        </pre></code>
      </div>




      <br>
      <br>

      <button type="button" class="btn btn-default btn-lg btn-block" onclick="toggleOutText();">
        <span class="glyphicon glyphicon-collapse-down" aria-hidden="true"></span>
        Toggle results file
      </button>

      <div id="out">
        <code><pre id="outText">

        </pre></code>
      </div>


    </div>


  </div>






























<script type="text/javascript">

  outHidden = true;
  $("#outText").hide();


  // Check if client's browser version can handle HTML5's Local Storage
  if(typeof(Storage) !== "undefined") {
    ;
  } else {
      alert("Update your Browser or use Google Chrome (Error: HTML5's Local Storage is not supported in this browser version.");
  }


  var debug = true;
  var commentsDict = [];
  var lines = [];
  var lines_current_subset = [];
  //var phrases = [];
  var file = null;
  var current_line_pointer = 2;
  var phrase_pointer = 1;
  var lines_last_subset = undefined;

  $('#buttons_and_comments').hide();

  document.getElementById('file').onchange = function(){
    console.log( "file selected , onchange() was called\n" );

    file = this.files[0];

    var reader = new FileReader();
    reader.onload = function(progressEvent){
      // save lines to a global variable
      var s_temp = 'dummy_line\n'+this.result;
      console.log('pppppppp:'+s_temp.substring(0,20));
      lines = s_temp.split('\n');
      calculateCurrentLinesSubset();
      updateText();
      updateId();
      updateMyLogger();
    };
    reader.readAsText(file);

    $('#buttons_and_comments').show();
  };


  //show file selected in text input (readonly)
  $(document).on('change', '#file', function() {
    var input = $(this),
        numFiles = input.get(0).files ? input.get(0).files.length : 1,
        label = input.val().replace(/\\/g, '/').replace(/.*\//, '');
    input.trigger('fileselect', [numFiles, label]);
  });


  function nextPhrase()
  {
    console.log("nextPhrase function was called\n");
    if (phrase_pointer<lines_current_subset.length-1) {
      phrase_pointer += 1;
      updateText();
      updateId();
    } else {
      nextComment();
    }
  }

  function previousPhrase()
  {
    console.log("previousPhrase function was called\n");
    console.log('current_line_pointer:' +current_line_pointer);
    if (phrase_pointer>1) {
      phrase_pointer -= 1;
      updateText();
      updateId();
    } else{
      previousComment(lines_last_subset.length-1);
    }
  }

  function nextComment()
  {
      console.log("nextComment function was called\n");
    if (current_line_pointer<lines.length-1) {
      console.log(lines_current_subset.length);
      current_line_pointer += lines_current_subset.length;
      calculateCurrentLinesSubset();
      phrase_pointer = 1;
      updateText();
      updateId();
    }
  }

  function previousComment(phrase_pointer_argument_passing)
  {
      console.log("previousComment function was called\n");
    if (current_line_pointer>1) {
      current_line_pointer -= lines_last_subset.length;
      console.log('current_line_pointer:' +current_line_pointer);
      calculateCurrentLinesSubset();
      phrase_pointer = phrase_pointer_argument_passing;
      updateText();
      updateId();
    }
  }
  function calculateCurrentLinesSubset()
  {
    var current_line_pointer_cpy = current_line_pointer;
    if (lines_current_subset!=undefined){
      lines_last_subset = lines_current_subset;
    }
    lines_current_subset=[];

    for (var i=1;i<200;i++) { //maximo examinar max 200 lineas para que no exista un loop infinito
      if (current_line_pointer_cpy>=lines.length) {
        console.log('break (malo solo deberia pasar cuando se acaba el archivo) with i='+i)
        break;
      }
      var id = mysplit(lines[current_line_pointer_cpy],',',1)[0];
      
      if ( i>1 && id!=lastId) {
        console.log('break (bueno) with i='+i)
        break;
      }
      var lastId = id;
      lines_current_subset.push(lines[current_line_pointer_cpy]);
      current_line_pointer_cpy++;
    }

  }
  function updateId()
  {
    var line = mysplit(lines_current_subset[phrase_pointer],',',2);
    showId(line[0]+'-'+line[1]);
  }
  function updateText()
  {
    var comment = '';

    for (var i=1;i<lines_current_subset.length; i++){
      var splitted_line = mysplit(lines_current_subset[i],',',5);
      if (i!=phrase_pointer) {
        comment += splitted_line[5].replace(/<[^>]+>/g,''); //esto es para ignorar todos los tags
      } else {
        comment += '<mark>'+splitted_line[5].replace(/<[^>]+>/g,'')+'</mark>';
      }
    }
    showText(comment);
  }
  function updateMyLogger()
  {
    if (debug) {
      $('#mylogger').show();
      var s = '';
      s += 'current line pointer:'+current_line_pointer;
      s += '<br>phrase pointer:'+phrase_pointer;
      s += '<br>length of current subset of lines:'+lines_current_subset.length;
      showLog(s);
    } else {
      $('#mylogger').hide();
    }
  }


  function yes()
  {
    console.log("yes() function was called\n");

    localStorage.setItem(""+current_line_pointer, lines[current_line_pointer].split(',',1)[0]+",1\n");

    console.log(""+localStorage.getItem(""+current_line_pointer));
  }

  function no()
  {
    console.log("no() function was called\n");

    localStorage.setItem(""+current_line_pointer, lines[current_line_pointer].split(',',1)[0]+",0\n");

    console.log(""+localStorage.getItem(""+current_line_pointer));
  }        


  //jquery
  jQuery(document).ready(function($) {

    window.showText = function(str)
    {
      console.log("showText() was called");
      str = str.replace(/<\/?p>|<\/?p>|/g,'');
      str = str.replace(/\\n/g,'<br>');
      html = $.parseHTML( str );

      // Append the parsed HTML
      $("#commentPre").empty();
      $("#commentPre").append(html);
 
    };

    window.showId = function(str)
    {
      console.log("showId() was called");

      $("#id_comment").empty();
      $("#id_comment").append( "id: "+ str );
 
    }

    window.showLog = function(str)
    {
      $('#mylogger').empty();
      $('#mylogger').append(str);
    }

  });


  function mysplit(aString, aChar, maxSplit) {
      var aStringCpy = aString.slice(0);
      var arr = [];
      var j=-1;


      for (var n=0; n<=maxSplit; n++) {
          aStringCpy = aStringCpy.slice(j+1)
          if (n==maxSplit) {
              arr.push(aStringCpy.slice(0));
              break;
          }
          j = aStringCpy.indexOf(aChar);
          arr.push(aStringCpy.slice(0,j));
      
      }
      return arr;
  }



  function toggleOutText() {
      if (outHidden) {
        $("#outText").empty();
        for (var n=1;n<lines.length;n++) { //bug. no revisar todas las lineas. algunas no tienen nada asignado en localstorage
          $("#outText").append( localStorage.getItem(""+lines[n].split(',',1)[0]) );
        }

        $('#outText').show();
        outHidden = false;
      } else {
        $('#outText').hide();
        outHidden = true;
      }
  }

</script>



<!-- [Bootstrap] Latest compiled and minified JavaScript -->
<script src="bootstrap/bootstrap.min.js"></script> 

</body>
</html>