<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>CommentsReaderApp</title>

  <!-- Latest compiled and minified CSS -->
  <link rel="stylesheet" href="bootstrap/bootstrap.min.css">

  <!-- Optional theme -->
  <link rel="stylesheet" href="bootstrap/bootstrap-theme.min.css">

  <script type="text/javascript" src="jquery-2.1.3.js"></script>
  <script type="text/javascript" src="keypress.js"></script>
  <script type="text/javascript">
    $(document).ready(function() {
      var listener = new window.keypress.Listener();
      listener.simple_combo("y", yes);
      listener.simple_combo("n", no);
      listener.simple_combo("up", yes);
      listener.simple_combo("down", no);
      listener.simple_combo("left", previousComment);
      listener.simple_combo("right", nextComment);
    })
  </script>

  <style>
  .btn-file {
    position: relative;
    overflow: hidden;
  }
  .btn-file input[type=file] {
    position: absolute;
    top: 0;
    right: 0;
    min-width: 100%;
    min-height: 100%;
    font-size: 100px;
    text-align: right;
    filter: alpha(opacity=0);
    opacity: 0;
    background: red;
    cursor: inherit;
    display: block;
  }
  input[readonly] {
    background-color: white !important;
    cursor: text !important;
  }
  </style>


</head>
<body>

  <div class="container" style="margin-top: 10px">

    <div class="row" style="margin-bottom: 10px">
      <div class="col-lg-6 col-sm-6 col-12">
        <h4>Open a file with comments:</h4>
        <div class="input-group">
          <span class="input-group-btn">
            <span class="btn btn-info btn-file">
              Browse <input type="file" id="file">
            </span>
          </span>
          <input type="text" class="form-control" readonly>
        </div>
      </div>
    </div>


    <div id="buttons_and_comments">
      <div id="buttons" style="margin-top: 30px">
        <div class="row">
          <div class="btn-group col-md-3 col-md-offset-5">
            <button type="button" class="btn btn-success btn-lg btn-block" onclick="yes();">
              <span class="glyphicon glyphicon-triangle-top" aria-hidden="true"></span>
              Directive
            </button>
          </div>
        </div>


        <div class="row">
          <div class="col-md-2 col-md-offset-3">
            <button type="button" class="btn btn-default btn-lg btn-block" onclick="previousComment();">
              <span class="glyphicon glyphicon-triangle-left" aria-hidden="true"></span>
              Prev
            </button>
          </div>
          <div class="col-md-3">
            <button type="button" class="btn btn-danger btn-lg btn-block" onclick="no();">
              <span class="glyphicon glyphicon-triangle-bottom" aria-hidden="true"></span>
              Non-Directive
            </button>
          </div>
          <div class="col-md-2">
            <button type="button" class="btn btn-default btn-lg btn-block" onclick="nextComment();">
              Next
              <span class="glyphicon glyphicon-triangle-right" aria-hidden="true"></span>
            </button>
          </div>
        </div>
      </div>


      <br>
      <br>
      <div class="text-center">
        <h3 id="id_comment">id</h3>
      </div>

      <h3>Comment:</h3>

      <div id="comment">
        <code><pre id="commentPre">

        </pre></code>
      </div>




      <br>
      <br>

      <button type="button" class="btn btn-default btn-lg btn-block" onclick="toggleOutText();">
        <span class="glyphicon glyphicon-collapse-down" aria-hidden="true"></span>
        Toggle results file
      </button>

      <div id="out">
        <code><pre id="outText">

        </pre></code>
      </div>


    </div>


  </div>












<script type="text/javascript">

  outHidden = true;
  $("#outText").hide();


  // Check if client's browser version can handle HTML5's Local Storage
  if(typeof(Storage) !== "undefined") {
    ;
  } else {
      alert("Update your Browser or use Google Chrome (Error: HTML5's Local Storage is not supported in this browser version.");
  }



  var commentsDict = [];
  var lines = [];
  var file = null;
  var current_line_pointer = 1;

  $('#buttons_and_comments').hide();

  document.getElementById('file').onchange = function(){
    console.log( "file selected , onchange() was called\n" );

    file = this.files[0];

    var reader = new FileReader();
    reader.onload = function(progressEvent){
      // save lines to a global variable
      lines = this.result.split('\n');
      showCommentAndId();
    };
    reader.readAsText(file);

    $('#buttons_and_comments').show();
  };


  function nextComment()
  {
    if (current_line_pointer<lines.length-1) {
      console.log("nextComment function was called\n");
      current_line_pointer += 1;
      showCommentAndId();
    }
  }

  function previousComment()
  {
    if (current_line_pointer>1) {
      console.log("previousComment function was called\n");
      current_line_pointer -= 1;
      showCommentAndId();
    }
  }

  function showCommentAndId()
  {
    var list_of_str = mysplit(lines[current_line_pointer],',',3);
    showText(list_of_str[3]);
    showId(list_of_str[0]);
  }


  function yes()
  {
    console.log("yes() function was called\n");

    localStorage.setItem(""+current_line_pointer, lines[current_line_pointer].split(',',1)[0]+",1\n");

    console.log(""+localStorage.getItem(""+current_line_pointer));
  }

  function no()
  {
    console.log("no() function was called\n");

    localStorage.setItem(""+current_line_pointer, lines[current_line_pointer].split(',',1)[0]+",0\n");

    console.log(""+localStorage.getItem(""+current_line_pointer));
  }        


  //jquery
  jQuery(document).ready(function($) {

    window.showText = function(str)
    {
      console.log("showText() was called");
      html = $.parseHTML( str.replace(/\\n/g,"<br>") );

      // Append the parsed HTML
      $("#commentPre").empty();
      $("#commentPre").append(html);
 
    };

    window.showId = function(str)
    {
      console.log("showId() was called");

      $("#id_comment").empty();
      $("#id_comment").append( "id: "+ str );
 
    }

  });


  function mysplit(aString, aChar, maxSplit) {
      var aStringCpy = aString.slice(0);
      var arr = [];
      var j=-1;


      for (var n=0; n<=maxSplit; n++) {
          aStringCpy = aStringCpy.slice(j+1)
          if (n==maxSplit) {
              arr.push(aStringCpy.slice(0));
              break;
          }
          j = aStringCpy.indexOf(aChar);
          arr.push(aStringCpy.slice(0,j));
      
      }
      return arr;
  }



  function toggleOutText() {
      if (outHidden) {
        $("#outText").empty();
        for (var n=1;n<lines.length;n++) { //bug. no revisar todas las lineas. algunas no tienen nada asignado en localstorage
          $("#outText").append( localStorage.getItem(""+lines[n].split(',',1)[0]) );
        }

        $('#outText').show();
        outHidden = false;
      } else {
        $('#outText').hide();
        outHidden = true;
      }
  }

</script>



<!-- [Bootstrap] Latest compiled and minified JavaScript -->
<script src="bootstrap/bootstrap.min.js"></script> 

</body>
</html>